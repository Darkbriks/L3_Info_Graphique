<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>TP5 Three.js - Exo 5</title>
    <style>
        body {
            margin: 0;
        }
    </style>
</head>

<body>

<!-- Ajouter un bouton pour centré la caméra sur chaque planète -->
<div id="focus-buttons"></div>

<!-- inclusion de la librairie Three.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.js"></script>

<script src="js/mesObjets.js"></script>
<script src="js/CelestialBody.js"></script>
<script src="js/CelestialBodyData.js"></script>
<script src="js/ArcballControls.js"></script>

<script>
    const clock = new THREE.Clock();

    // Création de la caméra
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.01, 10000000);
    // placer la caméra au dessus du plan de l'écliptique
    camera.position.set(0, 100000, 0);
    camera.lookAt(0, 0, 0);

    // création de la scène
    const scene = new THREE.Scene();

    // création du rendu
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // ajout d'un contrôleur de caméra
    let control = new THREE.ArcballControls(camera, renderer.domElement, scene);

    // Ajout d'une skybox
    const loader = new THREE.TextureLoader();
    loader.load('Images/2k_stars_milky_way.jpg', function (texture) {
        texture.mapping = THREE.EquirectangularReflectionMapping;
        scene.background = texture;
    });

    celestialBodiesData.forEach(data => {
        new CelestialBody(data);
    });
    CelestialBody.initAll();

    let light = new THREE.PointLight(0xffffff, 1, 0, 2);
    let Sun = CelestialBody.GetBodyByName('Sun');
    Sun.mesh.add(light);
    Sun.mesh.castShadow = false;
    Sun.mesh.receiveShadow = false;

    let cameraTarget = Sun.mesh;
    let cameraTargetLastPosition = new THREE.Vector3();

    function animer() {
        let deltaTime = clock.getDelta();
        let elapsedTime = clock.elapsedTime * 100000;

        CelestialBody.updateAllRotation(elapsedTime);
        CelestialBody.updateAllPosition(elapsedTime);

        let dx = cameraTarget.position.x - cameraTargetLastPosition.x;
        let dy = cameraTarget.position.y - cameraTargetLastPosition.y;
        let dz = cameraTarget.position.z - cameraTargetLastPosition.z;
        camera.position.x += dx;
        camera.position.y += dy;
        camera.position.z += dz;
        cameraTargetLastPosition = cameraTarget.position.clone();

        control.update();
        renderer.render(scene, camera);
        requestAnimationFrame(animer);
    }

    // ajout des gestionnaires d'évènements
    this.addEventListener('resize', function () {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }, false);

    animer();

</script>
</body>
</html>